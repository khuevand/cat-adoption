// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum Sex {
  MALE
  FEMALE
  UNKNOWN
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  WITHDRAWN
}

enum CatStatus {
  AVAILABLE
  PENDING
  ADOPTED
  FOSTERED
}

model User {
  id String @id
  name String? 
  email String? @unique
  createdAt DateTime @default(now())
  applications Application[]
  donation Donation[]
  totalDonation Int @default(0)
  cat Cat[]  
}

model Admin {
  id String @id
  name String?
  email String? @unique
  createdAt DateTime @default(now())
  listCats Cat[]
  catImages CatImage[]
  applicationUploaded Application[]

  @@index([id])
}

model Donation {
  id String @id @default(cuid())
  total Int
  user User @relation(fields: [userId], references: [id])
  userId String
  createdAt DateTime @default(now())
}

model Application {
  id String @id @default(cuid())
  cat Cat @relation(fields: [catId], references: [id], onDelete: Cascade)
  catId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  status ApplicationStatus @default(PENDING)
  form Json

  decidedById  String?
  decidedBy Admin? @relation(fields: [decidedById], references: [id], onDelete: SetNull)
  decidedAt DateTime?
  decisionNote String?

  @@index([userId])
  @@index([catId, status])
  @@index([decidedById])
  @@index([decidedAt])
}

model Cat {
  id String @id @default(cuid())
  name String
  breed String
  sex Sex @default(UNKNOWN)
  ageMonths Int
  desexed Boolean @default(false)
  vaccinated Boolean @default(false)
  microchipped Boolean @default(false)
  description String
  status CatStatus @default(AVAILABLE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  owner User? @relation(fields: [userId], references: [id])
  listedBy Admin @relation(fields: [adminId], references: [id])
  userId String ?
  adminId String
  applications Application[]
  images CatImage[]
  primaryImageUrl String?

  @@index([ageMonths])
  @@index([sex])
  @@index([status])
  @@index([userId])
  @@index([adminId])
}

model CatImage {
  id String @id @default(cuid())
  cat Cat @relation(fields: [catId], references: [id], onDelete: Cascade)
  catId String
  url String
  sizeBytes Int?
  alt String?
  isPrimary Boolean @default(false)
  uploadedBy Admin @relation(fields: [uploadedById], references: [id])
  uploadedById String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([catId, isPrimary])
}
